name: Deploy Website

# Define the events that trigger the workflow
on:
  # 1. Trigger on 'push' to the default branch (e.g., 'main' or 'master')
  push:
    branches:
      - main  # Adjust 'main' to your default branch name (e.g., 'master')

  # 2. Trigger on 'pull_request' events (equivalent to 'merge_request_event' in GitLab)
  pull_request:
    branches:
      - main  # Trigger for PRs targeting the default branch

# Environment variables that are used across jobs
env:
  CLOUDFLARE_PROJECT_NAME: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}

jobs:
  # The GitLab 'stages' concept is implemented by chaining 'needs' in jobs.
  # We will have 'build', 'deploy_review' (implied by pull_request trigger), and 'deploy_prod'.

  build:
    name: Build Website
    # üèÉ Equivalent to 'image: node:24-alpine'
    runs-on: ubuntu-latest
    container:
      image: node:24-alpine
    
    # ‚öôÔ∏è This job runs on all configured triggers (push/pull_request)
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Show Versions
        run: |
          node --version
          npm --version
      
      - name: Install Dependencies and Build
        run: |
          npm ci
          npm run build
          
      # üì¶ Equivalent to 'artifacts: paths: - dist/'
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: website-dist
          path: dist/
          # Retention period can be set here if needed

  # Equivalent to the 'deploy_production' job
  deploy_production:
    name: Deploy to Production
    # This job only runs if the 'build' job succeeded
    needs: [build]
    
    # Equivalent to 'rules: - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH'
    # This ensures the job only runs when code is merged/pushed to the default branch.
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' # Adjust 'main' if needed
    
    runs-on: ubuntu-latest
    
    steps:
      # Download the artifact generated by the 'build' job
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: website-dist
          path: dist/

      - name: Deploy to Cloudflare Pages
        run: |
          echo "Deploying to production..."
          npm install -g wrangler
          wrangler pages deploy dist --project-name=${{ env.CLOUDFLARE_PROJECT_NAME }}
        env:
          # Use Cloudflare secrets for authentication
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          # You might need this for older wrangler versions or specific setups
          # CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}